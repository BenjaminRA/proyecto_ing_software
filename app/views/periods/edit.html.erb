<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>Períodos</h2>
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="<%= url_for :controller => 'periods', :action => 'index' %>">Períodos</a>
            </li>
            <li class="breadcrumb-item">
                <strong>Editar Período</strong>
            </li>
        </ol>
    </div>
</div>


<div class="wrapper wrapper-content animated fadeInRight">
<div class="ibox-content m-b-sm border-bottom">
<%= form_tag "/periods/#{params[:id]}", :method => "put", :id => "new_period", :autocomplete => "off"%>
    <div class="form-group">
        <label>Inicio y término del período</label>
        <div class="input-daterange input-group" id="datepicker">
            <input required type="text" class="form-control-sm form-control" name="start" value="<%= @start %>"/>
            <span class="input-group-addon input-group-addon">Hasta</span>
            <input required type="text" class="form-control-sm form-control" name="end" value="<%= @end %>"/>
        </div>
    </div>
    <div class="hr-line-dashed"></div>
    <div id="wizard">
        <h1>Colaboradores</h1>
        <div class="step-content" style="position: relative">
            <label>Seleccione a los colaboradores de este periodo</label>
            <select name="collaborators[]" class="form-control collaborators_select" multiple required>
                <% @collaborators.each do |collaborator| %>
                    <option value="<%= collaborator.id %>"><%= collaborator.user.name %> <%= collaborator.user.last_name %> - <%= collaborator.user.rut %></option>
                <% end %>
            </select>
        </div>

        <h1>Evaluadores</h1>
        <div class="step-content" style="position: relative">
            <select id="evaluators_select" name="evaluators[]" class="form-control evaulators_select" multiple>
                <% @evaluators_select.each do |collaborator| %>
                    <option value="<%= collaborator[:id] %>"><%= collaborator[:name] %> <%= collaborator[:last_name] %> - <%= collaborator[:rut] %></option>
                <% end %>
            </select>
        </div>
    </div>
    <button id="submit_button" hidden type="submit">Guardar</button>
</form>
</div>
</div>

<% content_for :javascript do %>

<script>

    $(function() {

        let indexes_evaluators = []
        let indexes_collaborators = []
        let collaborators = []
        let evaluators = []
        let select_fields = []

        addOption = function(e) {
            for(let select_field of select_fields) {
                $(select_field).append(e)
                select_field.bootstrapDualListbox("refresh")
            }
        }

        removeOption = function(element) {
            const ids = $("#evaluators_select").val()
            if (indexes_evaluators.length !== 0) {
                let index = null
                let step_index = 0
                inner_loop:
                for (let i = 0; i < indexes_evaluators.length; ++i) {
                    if (gon.collaborators[indexes_evaluators[i]].id === element) {
                        index = indexes_evaluators[i]
                        step_index = evaluators.indexOf(gon.collaborators[index].id)
                        break inner_loop
                    }
                }
                if (index !== null) {
                    indexes_evaluators = indexes_evaluators.filter((e) => e !== index)
                    evaluators = evaluators.filter((e) => e !== evaluators[step_index])
                    select_fields = select_fields.filter((e) => e !== select_fields[step_index + 1])
                    $("#wizard").steps("remove",  step_index + 2)
                }

            }

            for(let select_field of select_fields) {
                $(`#${select_field[0].id} option[value="${element}"]`).remove()
                $(`#${select_field[0].id}`).bootstrapDualListbox("refresh")
            }
        }

        $("#wizard").steps({
            enableAllSteps: true,
            labels: {
                cancel: "Cancela",
                current: "Página actual:",
                pagination: "Paginación",
                finish: "Enviar",
                next: "Siguiente",
                previous: "Anterior",
                loading: "Cargando..."
            },
            onFinished: function (event, currentIndex) {
                $("#submit_button").trigger("click")
            },
        });

        // jQuery.validator.addMethod("overlapped_date", function(value, element) {
        //     let overlapped = false
        //     const start = Date(value)
        //     for(const period of gon.periods) {
        //         period
        //     }

        //     return this.optional(element) || !overlapped;
        // }, "Esta fecha se solapa con la de otro período");

        // $("#new_period").validate({
        //     rules: {
        //         start: {
        //             overlapped_date: true
        //         },
        //         end: {
        //             required: true,
        //         },
        //     },
        //     messages: {
        //         start: {
        //             required: "Este campo es requerido."
        //         },
        //         end: {
        //             required: "Este campo es requerido."
        //         },
        //     }
        // })
        
        $('.input-daterange').datepicker({
            keyboardNavigation: false,
            forceParse: false,
            autoclose: true
        })

        const collaborators_select = $(".collaborators_select")
        collaborators_select.bootstrapDualListbox({
            selectorMinimalHeight: 160,
            filterPlaceHolder: "Buscar Colaborador",
            preserveSelectionOnMove: 'moved',
            infoText: 'Mostrando {0}',
            infoTextFiltered: '<span class="label label-warning">Fildrados</span> {0} de {1}',
            infoTextEmpty: 'Lista vacía',
        })

        const evaulators_select = $(".evaulators_select")
        evaulators_select.bootstrapDualListbox({
            selectorMinimalHeight: 160,
            filterPlaceHolder: "Buscar Evaluador",
            infoText: 'Mostrando {0}',
            infoTextFiltered: '<span class="label label-warning">Fildrados</span> {0} de {1}',
            infoTextEmpty: 'Lista vacía',
            iconMove: 'fa-arrow-circle-o-right',
            iconRemove: 'fa-arrow-circle-o-left'

        })

        select_fields.push(evaulators_select)

        collaborators_select.on("change", function(e) {
            let ids = $(this).val()
            if(ids.length >= indexes_collaborators.length) {
                while(ids.length !== indexes_collaborators.length) {
                    let current_collaborator = null
                    inner_loop:
                    for (let i = 0; i < ids.length; ++i) {
                        for (let j = 0; j < gon.collaborators.length; ++j) {
                            if(gon.collaborators[j].id == ids[i] && !indexes_collaborators.includes(j)) {
                                indexes_collaborators.push(j)
                                current_collaborator = gon.collaborators[j]
                                break inner_loop
                            }
                        }
                    }
                    addOption($('<option>', {
                        value: current_collaborator.id,
                        text: `${current_collaborator.name} ${current_collaborator.last_name} - ${current_collaborator.rut}`
                    }))
                }
            }
            else {
                while(ids.length !== indexes_collaborators.length) {
                    let index = null
                    inner_loop:
                    for (let i = 0; i < indexes_collaborators.length; ++i) {
                        if (!ids.includes(gon.collaborators[i].id.toString())) {
                            index = indexes_collaborators[i]
                            break inner_loop
                        }
                    }
                    removeOption(gon.collaborators[index].id)
                    indexes_collaborators = indexes_collaborators.filter((e) => e !== index)
                }
            }
        })

        evaulators_select.on("change", function(e) {
            let ids = $(this).val()
            if(ids.length >= indexes_evaluators.length) {
                while(ids.length !== indexes_evaluators.length) {
                    let current_collaborator = null
                    inner_loop:
                    for (let i = 0; i < ids.length; ++i) {
                        for (let j = 0; j < gon.collaborators.length; ++j) {
                            if(gon.collaborators[j].id == ids[i] && !indexes_evaluators.includes(j)) {
                                indexes_evaluators.push(j)
                                current_collaborator = gon.collaborators[j]
                                evaluators.push(current_collaborator.id)
                                break inner_loop
                            }
                        }
                    }
                    $("#wizard").steps("add", {
                        title: `Evaluador: ${current_collaborator.name} ${current_collaborator.last_name}`,
                        content: `
                        <div class="step-content">
                            <select id="evaluates_${current_collaborator.id}_select" name="evaluates[${current_collaborator.id}][]" class="form-control evaluates${current_collaborator.id}_select" multiple>

                            </select>
                        </div>
                        `
                    })
                    const current_option = $(`.evaluates${current_collaborator.id}_select`)
                    for (let index of indexes_collaborators) {
                        if (gon.collaborators[index].id !== current_collaborator.id)
                            $(current_option).append($('<option>', {
                                value: gon.collaborators[index].id,
                                text: `${gon.collaborators[index].name} ${gon.collaborators[index].last_name} - ${gon.collaborators[index].rut}`
                            }))
                    }
                    current_option.bootstrapDualListbox({
                        selectorMinimalHeight: 160,
                        filterPlaceHolder: "Buscar Colaborador",
                        preserveSelectionOnMove: 'moved',
                        infoText: 'Mostrando {0}',
                        infoTextFiltered: '<span class="label label-warning">Fildrados</span> {0} de {1}',
                        infoTextEmpty: 'Lista vacía',
                    })
                    current_option[0].parentNode.parentNode.style.position = "relative"

                    select_fields.push(current_option)
                }
            }
            else {
                while(ids.length !== indexes_evaluators.length) {
                    let index = null
                    let step_index = 0
                    inner_loop:
                    for (let i = 0; i < indexes_evaluators.length; ++i) {
                        if (!ids.includes(gon.collaborators[indexes_evaluators[i]].id.toString())) {
                            index = indexes_evaluators[i]
                            step_index = evaluators.indexOf(gon.collaborators[index].id)
                            break inner_loop
                        }
                    }
                    if (index !== null) {
                        indexes_evaluators = indexes_evaluators.filter((e) => e !== index)
                        evaluators = evaluators.filter((e) => e !== evaluators[step_index])
                        select_fields = select_fields.filter((e) => e[0].id !== `evaluates_${gon.collaborators[index].id}_select`)
                        $("#wizard").steps("remove",  step_index + 2)
                    }
                }
            }
        })

        // Init values

        for (let collaborator of gon.eval_collaborators) {
            inner_loop:
            for (let i = 0; i < gon.collaborators.length; ++i) {
                if(gon.collaborators[i].id == collaborator.id) {
                    indexes_collaborators.push(i)
                    break inner_loop
                }
            }
            $(`.collaborators_select option[value="${collaborator.id}"]`).prop('selected', true)
        }
        collaborators_select.bootstrapDualListbox("refresh")

        for (let evaluator of gon.eval_evaluators) {
            $(`.evaulators_select option[value="${evaluator.id}"]`).prop('selected', true)

            $("#wizard").steps("add", {
                title: `Evaluador: ${evaluator.name} ${evaluator.last_name}`,
                content: `
                <div class="step-content">
                    <select id="evaluates_${evaluator.id}_select" name="evaluates[${evaluator.id}][]" class="form-control evaluates${evaluator.id}_select" multiple>

                    </select>
                </div>
                `
            })

            inner_loop:
            for (let i = 0; i < gon.collaborators.length; ++i) {
                if(gon.collaborators[i].id == evaluator.id) {
                    indexes_evaluators.push(i)
                    break inner_loop
                }
            }
            evaluators.push(evaluator.id)

            const current_option = $(`.evaluates${evaluator.id}_select`)
            for (let index of indexes_collaborators) {
                if (gon.collaborators[index].id !== evaluator.id)
                    $(current_option).append($('<option>', {
                        value: gon.collaborators[index].id,
                        text: `${gon.collaborators[index].name} ${gon.collaborators[index].last_name} - ${gon.collaborators[index].rut}`
                    }))
            }
            current_option.bootstrapDualListbox({
                selectorMinimalHeight: 160,
                filterPlaceHolder: "Buscar Colaborador",
                preserveSelectionOnMove: 'moved',
                infoText: 'Mostrando {0}',
                infoTextFiltered: '<span class="label label-warning">Fildrados</span> {0} de {1}',
                infoTextEmpty: 'Lista vacía',
            })
            current_option[0].parentNode.parentNode.style.position = "relative"

            for(let collaborator of evaluator.to_evaluate)
                $(`.evaluates${evaluator.id}_select option[value="${collaborator.id}"]`).prop('selected', true)
            current_option.bootstrapDualListbox("refresh")

            select_fields.push(current_option)

        }
        evaulators_select.bootstrapDualListbox("refresh")
        

    })
</script>

<% end %>